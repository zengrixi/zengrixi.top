---
layout: mypost
title: osgEarth开发环境搭建
categories: [OSG]
---

以前做项目使用到了<strong style="color:#9b2ebd;">osgEarth</strong>三维地球，所以整理一份环境的安装搭建。

### 目录

- [所需工具](#所需工具（包含依赖）)
- [编译osg](#编译OpenSceneGraph)
- [编译osgEarth](#编译osgEarth)
  1. [编译curl](#编译curl-7.65.3)
  2. [编译sqlite3](#编译sqlite3)
  3. [编译proj](#编译proj6.2.0)
  4. [编译GDAL](#编译GDALL 3.2.1)
  5. [编译zlib](#编译zlib-1.2.11)

---

### 所需工具（包含依赖）

- [OpenSceneGraph-3.6.5](https://github.com/openscenegraph/OpenSceneGraph/releases/tag/OpenSceneGraph-3.6.5)

- [osgEarth-3.1.0](http://osgearth.org/)

  - [GDAL 3.2.1](https://gdal.org/download.html)
  - [curl-7.65.3](https://curl.se/download/curl-7.65.3.zip)
  - [proj6.2.0](https://proj.org/download.html)
  - [SQLite3](https://www.sqlite.org/download.html)
  - [zlib1.2.11](https://zlib.net/)

- [CMake3.20.4](https://cmake.org/download/)

- VS2019

- Qt5.12.0

  **（备注：博主提供编译好的库下载，如果需要请留言。）**

---

### 编译OpenSceneGraph

1. 使用CMake配置目标工程

   CMake配置好目录直接点击generate按钮选择vs2019和x64即可。

   ![conf1](conf1.png)

2. 编译生成好的工程

   打开目录后用vs2019打开编译好的sln工程，然后直接编译即可。（记得debug和release都编译一遍。）

   ![vsbuild1](vsbuild1.png)
---

### 编译osgEarth

osgEarth的编译比较复杂，需要把依赖项全部都编译出来。

#### 编译curl-7.65.3

下载解压后打开CMake选择目录

![conf2](conf2.png)

打开工程编译进行编译，得到库文件

![lib1](lib1.png)

#### 编译sqlite3

1. 首先下载三个压缩包：

   [sqlite-amalgamation-3350500.zip](https://www.sqlite.org/2021/sqlite-amalgamation-3350500.zip)

   [sqlite-dll-win64-x64-3350500.zip](https://www.sqlite.org/2021/sqlite-dll-win64-x64-3350500.zip)

   [sqlite-tools-win32-x86-3350500.zip](https://www.sqlite.org/2021/sqlite-tools-win32-x86-3350500.zip)

2. 新建一个文件夹sqlite3，将三个压缩包内的文件都解压到sqlite3文件夹中：

   ![folder1](folder1.png)

3. 打开vs2019新建空项目，然后将`sqlite3.c`、`sqlite3.h`、`sqlite3ext.h`、`sqlite3.def`四个文件添加到工程中：

   ![vsbuild2](vsbuild2.png)

4. C/C++ --> 预处理器 --> 预处理器定义：设置预定义处理：
   `_USRDLL`
   `SQLITE_ENABLE_RTREE`
   `SQLITE_ENABLE_COLUMN_METADATA`
   `SQLITE_ENABLE_FTS5`
   `SQLITE_ENABLE_UNLOCK_NOTIFY`

   ![vsconf1](vsconf1.png)

5. 设置模块定义文件,链接器 --> 输入 --> 模块定义文件：`sqlite3.def`：

   ![vsconf2](vsconf2.png)

6. 修改模块定义文件:在最后追加sqlite3_unlock_notify：

   ![vsconf3](vsconf3.png)

7. 配置类型改为静态库lib：

   ![vsconf4](vsconf4.png)

#### 编译proj6.2.0

1. 解压后配置CMake路径生成工程：

   ![conf3](conf3.png)

2. 打开vs2019命令行进入根目录，然后输入命令：

   ```shell
   mkdir build-vs2019x64
   cd build-vs2019x64
   msbuild ALL_BUILD.vcxproj /p:Configuration="Release"
   msbuild INSTALL.vcxproj /p:Configuration="Release"
   ```
   
   编译成功后在电脑C盘找到 **OSGeo4W** 文件夹，将文件夹复制到build目录下供后面使用。
   
   （**也可以直接在上面CMake中直接配置默认生成路径，博主这里使用的是默认的路径。**）

#### 编译GDAL 3.2.1

下载文件后解压，用文本编辑器打开目录下的**nmake.opt**文件进行修改：

将第42行的 MSVC_VER=1900 注释掉，然后在下面新增一行 `MSVC_VER=1929 #VS2019`。

（**PS：博主的是1929，可以参照[官网]([Predefined macros | Microsoft Docs](https://docs.microsoft.com/en-us/cpp/preprocessor/predefined-macros?view=msvc-160&viewFallbackFrom=vs-2019))得到自己的版本号**。）

![conf4](conf4.png)

找到`GDAL_HOME =`将生成文件的路径设置成你想要的位置。

找到`WIN64=YES`，如果生成64位版本取消注释本行。

找到`DLLBUILD=`设置为`1`启动动态编译、 `0`为静态编译。

找到`PROJ_INCLUDE` `PROJ_LIBRARY`，分别设置成 **OSGeo4W** 文件夹中对应的位置：

![conf5](conf5.png)

找到`SQLITE_INC` `SQLITE_LIB`,路径设置同上：

![conf6](conf6.png)

至此设置完成，保存文件开始编译：

用 **管理员模式** 打开vs2019命令行工具，进入目录输入命令（**PS：不用管理员模式打开在编译过程中可能会产生找不到系统头文件的问题！！！**）：

```shell
nmake /f makefile.vc MSVC_VER=1929 WIN64=1
nmake /f makefile.vc devinstall
```

debug编译：

```shell
nmake /f makefile.vc MSVC_VER=1929 WIN64=1WIN64=1 DEBUG=1
nmake /f makefile.vc devinstall
```

#### 编译zlib-1.2.11

1. 解压后进入根目录，找到win32文件夹，将里面的 **Makefile.msc** 文件复制一份到根目录。

2. 打开vs2019命令行工具输入：

   ```shell
   nmake /f Makefile.msc
   ```

   完成后根目录会生成对应的lib文件。

**至此！！！osgEarth的编译依赖终于全部解决，现在开始进行osgEarth本体的编译！！！**

打开CMake配置：

1. 添加**CURL**

   ![curl](curl.png)

2. 添加**GDAL**

   ![gdal](gdal.png)

3. 添加**LIBZIP**

   ![libzip](libzip.png)

4. 添加**OSG**

   ![osg](osg.png)

5. `Configure & Generate`

6. Open Project后开始编译：

